name: Fund NAV Notify

on:
  schedule:
    - cron: "0 7 * * *"  # æ¯å¤©21:00(ä¸­å›½æ—¶åŒº), UTC+0=13ç‚¹
  workflow_dispatch: {}  # æ‰‹åŠ¨è§¦å‘

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
    - name: Call Fund API
      run: |
        echo "Sending request..."
        RESPONSE=$(curl -s -X POST "https://api.efunds.com.cn/xcowch/front/fund/nav" \
          -H "Content-Type: application/json" \
          -d '{"fundCode":"012922","pageIndex":0,"pageSize":1,"startDate":"2022-11-17","endDate":"2025-11-30","siteID":"1"}')
        
        NAV=$(echo $RESPONSE | jq -r '.data.dataList[0].dwjz')
        DATE=$(echo $RESPONSE | jq -r '.data.dataList[0].fsrq')
        
        echo "NAV=$NAV" >> $GITHUB_ENV
        echo "DATE=$DATE" >> $GITHUB_ENV

    - name: Send Email
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.163.com  # æ›¿æ¢æˆä½ çš„é‚®ç®±æœåŠ¡
        server_port: 465
        username: ${{ secrets.MAIL_USER }}
        password: ${{ secrets.MAIL_PASS }}
        subject: "åŸºé‡‘012922æœ€æ–°å‡€å€¼: Â¥${{ env.NAV }}"
        to: ${{ secrets.MAIL_TO }}
        from: ${{ secrets.MAIL_USER }}
        body: |
          åŸºé‡‘å‡€å€¼å·²æ›´æ–°ğŸ“ˆ
          æ—¥æœŸï¼š${{ env.DATE }}
          å‡€å€¼ï¼š${{ env.NAV }}
          æ•°æ®æ¥æºï¼šæ˜“æ–¹è¾¾åŸºé‡‘
